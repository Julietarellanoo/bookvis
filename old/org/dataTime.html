<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>setwd('~/Dropbox/chapman/book/')</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="setwd('~/Dropbox/chapman/book/')"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-07-09 23:50:38 CEST"/>
<meta name="author" content="Oscar Perpiñán Lamigueiro"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/javascript" src="http://orgmode.org/mathjax/MathJax.js">
<!--/*--><![CDATA[/*><!--*/
    MathJax.Hub.Config({
        // Only one of the two following lines, depending on user settings
        // First allows browser-native MathML display, second forces HTML/CSS
        //  config: ["MMLorHTML.js"], jax: ["input/TeX"],
            jax: ["input/TeX", "output/HTML-CSS"],
        extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                     "TeX/noUndefined.js"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"], ["\\begin{displaymath}","\\end{displaymath}"] ],
            skipTags: ["script","noscript","style","textarea","pre","code"],
            ignoreClass: "tex2jax_ignore",
            processEscapes: false,
            processEnvironments: true,
            preview: "TeX"
        },
        showProcessingMessages: true,
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": {
             scale: 100,
             availableFonts: ["STIX","TeX"],
             preferredFont: "TeX",
             webFont: "TeX",
             imageFont: "TeX",
             showMathMenu: true,
        },
        MMLorHTML: {
             prefer: {
                 MSIE:    "MML",
                 Firefox: "MML",
                 Opera:   "HTML",
                 other:   "HTML"
             }
        }
    });
/*]]>*///-->
</script>
</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">setwd('~/Dropbox/chapman/book/')</h1>



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 SIAR 1</a></li>
<li><a href="#sec-2">2 SIAR 2</a></li>
<li><a href="#sec-3">3 Unemployment</a></li>
<li><a href="#sec-4">4 CO2</a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-3">
<h3 id="sec-1"><span class="section-number-3">1</span> SIAR 1</h3>
<div class="outline-text-3" id="text-1">


<p>
There is a variety of scientific researches interested in the
relationship between several meteorological variables. A suitable
approach is to display the time evolution of all of them either
using a panel for each of the variables or plotting them
superposed. The superposition of variables with different ranges
is not very useful (unless their values were previously rescaled),
so this option is postponed for later use. 
</p>
<p>
For this example we will use the daily data from the SIAR
meteorological station located at Aranjuez (Madrid). The code of
the province (28) and station (3) is extracted from
<a href="http://solar.r-forge.r-project.org/data/SIAR.csv">http://solar.r-forge.r-project.org/data/SIAR.csv</a>. Let's download a
multivariate time series of eight years of daily data from January
2004 to December 2011. 
</p>



<pre class="example">prov=28 ##madrid
est=3 ##aranjuez
start='01/01/2004'
end='31/12/2011'
</pre>


<p>
The URL of this data is defined with the information of the
province, station, and start and end dates.
</p>



<pre class="example">URL = paste("http://www.marm.es/siar/exportador.asp?T=DD&amp;P=", 
  prov, "&amp;E=", est, "&amp;I=", start, "&amp;F=", end, sep = "")

</pre>


<p>
The <code>read.zoo</code> from the <code>zoo</code> package accepts this string and
downloads the data to construct a <code>zoo</code> object<sup><a class="footref" name="fnr.1" href="#fn.1">1</a></sup>. Several
arguments are directly passed to <code>read.table</code> (<code>header</code>, <code>skip</code>,
etc.) and are conveniently detailed in the help page of this
function. The <code>index.column</code> is the number of the column with the
time index, and <code>format</code> defines the date format of this index.
</p>
<p>
\index{Packages!zoo@\texttt{zoo}}
\index{read.zoo@\texttt{read.zoo}}
</p>


<pre class="example">library(zoo)

aranjuez &lt;- read.zoo(URL, index.column = 1,
                     format = "%d/%m/%Y", 
                     header = TRUE, skip = 1, fill = TRUE,
                     dec = ",", as.is = TRUE)
</pre>


<p>
We will retain only a subset of the meteorological variables:
average, maximum and minimum ambient temperature; average and
maximum humidity; average and maximum wind speed; rainfall; solar
radiation on the horizontal plane; and evotranspiration.
</p>


<pre class="example">aranjuezClean &lt;- aranjuez[, c(1, 2, 4, 6, 7, 11, 13, 16, 17, 18)]

names(aranjuezClean) &lt;- c('TempAvg', 'TempMax', 'TempMin',
                          'HumidAvg', 'HumidMax',
                          'WindAvg', 'WindMax',
                          'Rain', 'Radiation', 'ET')


</pre>




<pre class="example">summary(aranjuezClean)
</pre>



<p>
\index{zoo@\texttt{zoo}}
From the summary it is clear that parts of these time series include erroneous outliers which can be
safely removed:
</p>


<pre class="example">aranjuezClean &lt;- within(as.data.frame(aranjuezClean),{
  TempMin[TempMin&gt;40] &lt;- NA
  HumidMax[HumidMax&gt;100] &lt;- NA
  WindAvg[WindAvg&gt;10] &lt;- NA
  WindMax[WindMax&gt;10] &lt;- NA
})

aranjuez &lt;- zoo(aranjuezClean, index(aranjuez))
</pre>





</div>

</div>

<div id="outline-container-2" class="outline-3">
<h3 id="sec-2"><span class="section-number-3">2</span> SIAR 2</h3>
<div class="outline-text-3" id="text-2">


<p>
Daily solar radiation\index{Data!Solar radiation} incident on the
horizontal plane is registered by meterological stations and
estimated from satellite images. This meteorological variable is
important for a wide variety of scientific disciplines and
engineering applications. Its variations and trends, dependent on
the location (mainly latitude, and also longitude and altitude)
and on time (day of the year) have been analysed and modelled in a
huge collection of papers and reports. In this section we will
focus our attention on the time evolution of the solar
radiation. The spatial distribution and the spatio-time behaviour
will be the subject of later sections.
</p>
<p>
The stations of the SIAR network\index{Data!SIAR} include first
class pyranometers according to the World Meteorological
Organization (WMO), whose absolute accuracy is within \(\pm 5\%\)
and is typically lower than \(\pm 3\%\). Solar irradiance is
recorded every fifteen minutes and then collated through a
datalogger within the station to generate the daily irradiation,
which is later sent to the regional and national centers. 
</p>
<p>
First let's download the solar radiation data of 2011 from the
meteorological stations of Navarra (<code>prov=31</code>). For each station
(<code>navarraSIAR$N_Estacion</code>) <code>read.zoo</code> downloads data from the
corresponding internet direction (<code>URL</code>) and provides the
information as a <code>zoo</code> object. This is the same approach used with
the Aranjuez station. 
</p>
<p>
The next code retrieves the daily irradiation of the whole set of
meteorological stations of Navarra with <code>lapply</code> and
<code>read.zoo</code>. The result is a list of <code>zoo</code> objects. Some stations
do not provide data for this time period and produce an
error. Therefore <code>read.zoo</code> is evaluated inside a <code>try</code> call to
remove these stations from the list. <code>do.call</code> and <code>cbind</code> provide
a <code>data.frame</code> only with the useful stations and whose column
names are the shortened form of the original names of the
stations.
\index{lapply@\texttt{lapply}}
\index{Packages!zoo@\texttt{zoo}}
\index{read.zoo@\texttt{read.zoo}}
\index{sapply@\texttt{sapply}}
\index{do.call\texttt{do.call}}
</p>


<pre class="example">library(zoo)

SIAR &lt;- read.csv('http://solar.r-forge.r-project.org/data/SIAR.csv')
table(SIAR$Provincia)

prov=31 ##navarra
navarraSIAR &lt;- subset(SIAR, Provincia=='Navarra')
start='01/01/2011'
end='31/12/2011'

navarra &lt;- lapply(navarraSIAR$N_Estacion, FUN=function(i){
  URL = paste("http://www.marm.es/siar/exportador.asp?T=DD&amp;P=", 
    prov, "&amp;E=", i, "&amp;I=", start, "&amp;F=", end, sep = "")
  dat &lt;- try(read.zoo(URL, index.column = 1,
                      format = "%d/%m/%Y", 
                      header = TRUE, skip = 1, fill = TRUE,
                      dec = ",", as.is = TRUE))
  if (class(dat)=='try-error') NULL else dat$Radiacion
})

names(navarra) &lt;- make.names(abbreviate(navarraSIAR$Estacion))

## Which stations are not accesible?
err &lt;- sapply(navarra, is.null)

navarra &lt;- do.call(cbind, navarra[!err])
</pre>






</div>

</div>

<div id="outline-container-3" class="outline-3">
<h3 id="sec-3"><span class="section-number-3">3</span> Unemployment</h3>
<div class="outline-text-3" id="text-3">


<p>
The data set arranges the information with a row for each category
(<code>Series.ID</code>) and a column for each monthly value. Besides, there
are columns with the annual summaries (<code>annualCols</code>). We rearrange
this <code>data.frame</code> dropping the <code>Series.ID</code> and the annual columns,
and transposing the data.
</p>

<p>
\index{Data!Unemployment}
</p>


<pre class="example">unemployUSA &lt;- read.csv('data/unemployUSA.csv')
nms &lt;- unemployUSA$Series.ID
annualCols &lt;- 14 + 13*(0:12) ##columns of annual summaries
unemployUSA &lt;- as.data.frame(t(unemployUSA[,-c(1, annualCols)]))
names(unemployUSA) &lt;- nms
head(unemployUSA)
</pre>


<p>
With the tranpose, the column names of the original data set are
now the row names of the <code>data.frame</code>. The <code>as.yearmon</code> function
of the <code>zoo</code> package converts the character vector of names into a
<code>yearmon</code> vector, a class for representing monthly data. With
<code>Sys.setlocale("LC_TIME", 'C')</code> we ensure that month abbreviations
(<code>%b</code>) are correctly interpreted in a non-english locale. This
vector is the time index of a new <code>zoo</code> object. 
</p>
<p>
\index{Packages!zoo@\texttt{zoo}}
\index{as.yearmon@\texttt{as.yearmon}}
\index{apply@\texttt{apply}}
\index{zoo@\texttt{zoo}}
</p>



<pre class="example">library(zoo)

Sys.setlocale("LC_TIME", 'C')
idx &lt;- as.yearmon(row.names(unemployUSA), format='%b.%Y')
unemployUSA &lt;- zoo(unemployUSA, idx)
</pre>


<p>
Last, those rows with <code>NA</code> values are removed.
</p>


<pre class="example">isNA &lt;- apply(is.na(unemployUSA), 1, any)
unemployUSA &lt;- unemployUSA[!isNA,]
</pre>




</div>

</div>

<div id="outline-container-4" class="outline-3">
<h3 id="sec-4"><span class="section-number-3">4</span> CO2</h3>
<div class="outline-text-3" id="text-4">


<p>
Each year of the data is stored in a column of the <code>CO2 data.frame</code>, and the country and indicator names are defined in
their respective columns. 
</p>
<p>
\index{Data!World Bank} \index{Data!CO2@$CO<sub>2</sub>$}
\index{Data!GNI}
</p>


<pre class="example">CO2 &lt;- read.csv('data/CO2_GNI_BM.csv')
head(CO2)
</pre>


<p>
Before using this dataset, we have to transform it in a way that
each indicator is stored in independent columns with the year and
country names in their own columns.  The first step is to reshape
it to the long format. After this, the <code>data.frame</code> shows the year
in its own column (<code>timevar</code>), but now the values of the
indicators are all mixed in a unique column (<code>v.names</code>).
\index{reshape@\texttt{reshape}}
</p>


<pre class="example">CO2data &lt;- reshape(CO2, varying=list(names(CO2)[5:16]),
                      timevar='Year', v.names='Value',
                      times=2000:2011,
                      direction='long')
head(CO2data)
</pre>

<p>
The second step is to transform the previous result to the wide
format. Now <code>reshape</code> keeps the columns of country names and years
(<code>idvar=c('Country.Name','Year')</code>), and add additional columns for
each level of the indicator vector (<code>timevar</code>'Indicator.Name'=).
</p>


<pre class="example">CO2data &lt;- CO2data[, c(1, 3, 5, 6)]
CO2data &lt;- reshape(CO2data, 
                   idvar=c('Country.Name','Year'),
                   timevar='Indicator.Name', direction='wide')

names(CO2data)[3:6] &lt;- c('CO2.PPP', 'CO2.capita', 'GNI.PPP', 'GNI.capita')

isNA &lt;- apply(is.na(CO2data), 1, any)
CO2data &lt;- CO2data[!isNA, ]

head(CO2data)
</pre>




<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn.1" href="#fnr.1">1</a></sup> DEFINITION NOT FOUND: fn:1
</p></div>
</div>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2012-07-09 23:50:38 CEST</p>
<p class="author">Author: Oscar Perpiñán Lamigueiro</p>
<p class="creator">Org version 7.8.11 with Emacs version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
