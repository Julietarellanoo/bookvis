<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>setwd('~/Dropbox/chapman/book/')</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="title" content="setwd('~/Dropbox/chapman/book/')"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-06-26 00:51:02 CEST"/>
<meta name="author" content="Oscar Perpiñán Lamigueiro"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">setwd('~/Dropbox/chapman/book/')</h1>




<pre class="example">setwd('~/Dropbox/chapman/book/')
</pre>



<p>
SIAR
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Different meteorological variables from the same station</a>
<ul>
<li><a href="#sec-1-1">1.1 xyplot</a></li>
<li><a href="#sec-1-2">1.2 Splom</a></li>
<li><a href="#sec-1-3">1.3 Reshape</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Different meteorological variables from the same station</h2>
<div class="outline-text-2" id="text-1">


<p>
There are a variety of scientific researches interested in the
relationship between several meteorological variables. A suitable
approach is to display the time evolution of all of them either
using a panel for each of the variables or plotting them
superposed. The superposition of variables with different ranges
is not very useful (unless their values were previously rescaled),
so this option is postponed for later use. 
</p>
<p>
For this example we will use the daily data from the SIAR
meteorological station located at Aranjuez (Madrid). The code of
the province (28) and station (3) is extracted from
<a href="http://solar.r-forge.r-project.org/data/SIAR.csv">http://solar.r-forge.r-project.org/data/SIAR.csv</a>. Let's download a
multivariate time series of eight years of daily data from January
2004 to December 2011. 
</p>



<pre class="example">prov=28 ##madrid
est=3 ##aranjuez
start='01/01/2004'
end='31/12/2011'
</pre>



<p>
The URL of this data is defined with the information of the
province, station, and start and end dates.
</p>



<pre class="example">URL = paste("http://www.marm.es/siar/exportador.asp?T=DD&amp;P=", 
  prov, "&amp;E=", est, "&amp;I=", start, "&amp;F=", end, sep = "")

</pre>



<p>
The <code>read.zoo</code> from the <code>zoo</code> package accepts this string and
downloads the data to construct a <code>zoo</code> object<sup><a class="footref" name="fnr.1" href="#fn.1">1</a></sup>. Several
arguments are directly passed to <code>read.table</code> (<code>header</code>, <code>skip</code>,
etc.) and are conveniently detailed in the help page of this
function. The <code>index.column</code> is the number of the column with the
time index, and <code>format</code> defines the date format of this index.
</p>



<pre class="example">library(zoo)

aranjuez &lt;- read.zoo(URL, index.column = 1,
                     format = "%d/%m/%Y", 
                     header = TRUE, skip = 1, fill = TRUE,
                     dec = ",", as.is = TRUE)
</pre>




<pre class="example">summary(aranjuez)
</pre>



<pre class="example">    Index              TempMedia         TempMax       HorMinTempMax 
Min.   :2004-01-01   Min.   :-5.309   Min.   :-2.362   Min.   :   0  
1st Qu.:2005-12-29   1st Qu.: 7.692   1st Qu.:14.530   1st Qu.:1350  
Median :2008-01-09   Median :13.810   Median :21.670   Median :1440  
Mean   :2008-01-03   Mean   :14.405   Mean   :22.531   Mean   :1434  
3rd Qu.:2010-01-02   3rd Qu.:21.615   3rd Qu.:30.875   3rd Qu.:1520  
Max.   :2011-12-31   Max.   :30.680   Max.   :41.910   Max.   :2350  
                                                                     
   TempMin         HorMinTempMin   HumedadMedia      HumedadMax     
Min.   : -12.980   Min.   :   0   Min.   : 19.89   Min.   :  35.88  
1st Qu.:   1.517   1st Qu.: 430   1st Qu.: 47.04   1st Qu.:  81.60  
Median :   7.170   Median : 520   Median : 62.58   Median :  91.00  
Mean   :   8.241   Mean   : 665   Mean   : 62.16   Mean   :  91.43  
3rd Qu.:  12.590   3rd Qu.: 640   3rd Qu.: 77.38   3rd Qu.:  94.90  
Max.   :1133.000   Max.   :2350   Max.   :100.00   Max.   :2310.00  
                                                                    
 HorMinHumMax      HumedadMin       HorMinHumMin    VelViento       
Min.   :   0.0   Min.   :   0.00   Min.   :   0   Min.   :  0.2510  
1st Qu.: 420.0   1st Qu.:  18.26   1st Qu.:1400   1st Qu.:  0.6672  
Median : 540.0   Median :  30.08   Median :1500   Median :  0.9210  
Mean   : 714.7   Mean   :  38.91   Mean   :1458   Mean   :  1.6378  
3rd Qu.: 710.0   3rd Qu.:  48.60   3rd Qu.:1600   3rd Qu.:  1.4418  
Max.   :2350.0   Max.   :1640.00   Max.   :2350   Max.   :359.6000  
                                                                    
  DirViento        VelVientoMax      DirVientoVelMax   HorMinVelMax 
Min.   :  0.093   Min.   :   0.000   Min.   :   0.0   Min.   :   0  
1st Qu.: 43.242   1st Qu.:   3.844   1st Qu.: 143.1   1st Qu.:1219  
Median : 84.500   Median :   5.155   Median : 244.4   Median :1359  
Mean   :140.953   Mean   :   8.177   Mean   : 220.6   Mean   :1354  
3rd Qu.:239.775   3rd Qu.:   6.791   3rd Qu.: 272.3   3rd Qu.:1525  
Max.   :359.900   Max.   :2142.000   Max.   :2328.0   Max.   :2357  
                                                                    
Precipitacion      Radiacion          EtPMon     
Min.   : 0.000   Min.   : 0.277   Min.   :0.000  
1st Qu.: 0.000   1st Qu.: 9.370   1st Qu.:1.168  
Median : 0.000   Median :16.660   Median :2.758  
Mean   : 1.094   Mean   :16.742   Mean   :3.091  
3rd Qu.: 0.200   3rd Qu.:24.650   3rd Qu.:4.926  
Max.   :49.730   Max.   :32.740   Max.   :8.564  
NA's   :4        NA's   :13       NA's   :18
</pre>


<p>
For the subsequent display we will retain only a subset of the
meteorological variables: average, maximum and minimum ambient
temperature; average and maximum humidity; average and
maximum wind speed; rainfall; solar radiation on the
horizontal plane; and evotranspiration.
</p>


<pre class="example">aranjuezClean &lt;- aranjuez[, c(1, 2, 4, 6, 7, 11, 13, 16, 17, 18)]

names(aranjuezClean) &lt;- c('TempAvg', 'TempMax', 'TempMin',
                          'HumidAvg', 'HumidMax',
                          'WindAvg', 'WindMax',
                          'Rain', 'Radiation', 'ET')
</pre>



<p>
Parts of these time series include erroneous outliers which can be
safely removed.
</p>


<pre class="example">aranjuezClean &lt;- within(as.data.frame(aranjuezClean),{
  TempMin[TempMin&gt;40] &lt;- NA
  HumidMax[HumidMax&gt;100] &lt;- NA
  WindAvg[WindAvg&gt;10] &lt;- NA
  WindMax[WindMax&gt;10] &lt;- NA
})

aranjuez &lt;- zoo(aranjuezClean, index(aranjuez))
</pre>




<pre class="example">summary(aranjuez)
</pre>



<pre class="example">    Index               TempAvg          TempMax          TempMin       
Min.   :2004-01-01   Min.   :-5.309   Min.   :-2.362   Min.   :-12.980  
1st Qu.:2005-12-29   1st Qu.: 7.692   1st Qu.:14.530   1st Qu.:  1.515  
Median :2008-01-09   Median :13.810   Median :21.670   Median :  7.170  
Mean   :2008-01-03   Mean   :14.405   Mean   :22.531   Mean   :  6.888  
3rd Qu.:2010-01-02   3rd Qu.:21.615   3rd Qu.:30.875   3rd Qu.: 12.590  
Max.   :2011-12-31   Max.   :30.680   Max.   :41.910   Max.   : 22.710  
                                                       NA's   :4        
   HumidAvg         HumidMax         WindAvg         WindMax      
Min.   : 19.89   Min.   : 35.88   Min.   :0.251   Min.   : 0.000  
1st Qu.: 47.04   1st Qu.: 81.60   1st Qu.:0.667   1st Qu.: 3.783  
Median : 62.58   Median : 90.90   Median :0.920   Median : 5.027  
Mean   : 62.16   Mean   : 87.22   Mean   :1.174   Mean   : 5.208  
3rd Qu.: 77.38   3rd Qu.: 94.90   3rd Qu.:1.431   3rd Qu.: 6.537  
Max.   :100.00   Max.   :100.00   Max.   :8.260   Max.   :10.000  
                 NA's   :13       NA's   :8       NA's   :128     
     Rain          Radiation            ET       
Min.   : 0.000   Min.   : 0.277   Min.   :0.000  
1st Qu.: 0.000   1st Qu.: 9.370   1st Qu.:1.168  
Median : 0.000   Median :16.660   Median :2.758  
Mean   : 1.094   Mean   :16.742   Mean   :3.091  
3rd Qu.: 0.200   3rd Qu.:24.650   3rd Qu.:4.926  
Max.   :49.730   Max.   :32.740   Max.   :8.564  
NA's   :4        NA's   :13       NA's   :18
</pre>



</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> xyplot</h3>
<div class="outline-text-3" id="text-1-1">

<p>This multivariate time series can be directly displayed with the
<code>xyplot</code> method of <code>lattice</code> using the <code>layout</code> argument to
display the variables with parallel panels arranged in rows.
</p>



<pre class="example">xyplot(aranjuez, layout=c(1, ncol(aranjuez)))
</pre>


<p>
<a href="aranjuez.pdf">aranjuez.pdf</a>
</p>
<p>
This first attempt can be improved with a custom panel
function. This function will generate the content of each panel
using the information processed by <code>xyplot</code>. Since these functions
are executed consecutively, the order of the functions determines
the superposition of information:
</p><ul>
<li>The label of each time series is displayed with text inside each
  panel instead of using the strips mechanism. The <code>panel.text</code>
  prints the name of each variable with the aid of <code>panel.number</code>.
</li>
<li>The alternation of years is displayed with blocks of gray and
  white color using the <code>panel.xblocks</code> function from
  <code>latticeExtra</code>. The year is extracted (as character) from the
  time index of the <code>zoo</code> object with <code>format.POSIXlt</code>.
</li>
<li>Those values below the mean of each variable are highlighted
  with short red color blocks at the bottom of each panel, again
  with the <code>panel.xblocks</code> function.
</li>
</ul>





<pre class="example">Year &lt;- function(x)format(x, "%Y")

xyplot(aranjuez, layout=c(1, ncol(aranjuez)), strip=FALSE,
       scales=list(y=list(cex=0.6, rot=0)),
       panel=function(x, y, ...){
         panel.xblocks(x, Year, col = c("lightgray", "white"),
                       border = "darkgray")
         panel.xblocks(x, y&lt;mean(y, na.rm=TRUE), col = "indianred1",
                       height=unit(0.05, 'npc'))
         panel.xyplot(x, y, ...)
         panel.text(x[1], min(y, na.rm=TRUE),
                    names(aranjuez)[panel.number()],
                    cex=0.7, pos=2,...)
       })

</pre>


<p>
<a href="aranjuez.xblocks.pdf">aranjuez.xblocks.pdf</a>
</p>

</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Splom</h3>
<div class="outline-text-3" id="text-1-2">

<p>But, what if instead of displaying the time evolution we want to
confront the variables between them? Then a matrix of scatter
plots is the answer. This graphical tool is implemented in the
<code>splom</code> function. 
</p>



<pre class="example">splom(as.data.frame(aranjuez))
</pre>



<p>
However, for large datasets, the display of a large number of
points in a scatter plot matrix produces hidden point density,
long computation times and slow displays. These problems can be
circumvented with the estimation and representation of points
densities.  A common encoding uses gray scales, pseudo colors or
partial transparency. An improved scheme encodes density as the
size of hexagon symbols inscribed within hexagonal binning region
\cite{Carr.Littlefield.ea1987}.
</p>
<p>
The <code>hexbin</code> package includes several functions for hexagonal
binning.  The <code>panel.hexbinplot</code> is a good substitute for the
default panel function. Besides, our first attempt with <code>splom</code>
can be improved with several modifications:
</p><ul>
<li>The scales ticks and labels are suppressed with <code>pscale=0</code>.
</li>
<li>The panels of the lower part of the matrix (<code>lower.panel</code>) will include a
  locally weighted scatterplot smoothing (loess) with
  <code>panel.loess</code>.
</li>
<li>The diagonal panels (<code>diag.panel</code>) will display the kernel
  density estimate of each variable. The <code>density</code> function
  computes this estimate. The result is adjusted to the panel
  limits (calculated with <code>current.panel.limits</code>). The kernel
  density is plotted with <code>panel.lines</code> and the <code>diag.panel.splom</code>
  function completes the content of each diagonal panel (since
  <code>pscale=0</code> this function only generates the label of each variable).
</li>
<li>The point density is encoded with the palette <code>BTC</code> (ligther
  colors for high density values and darker colors for almost
  empty regions, with a gradient of blue hues for intermediate values).
</li>
</ul>





<pre class="example">library(hexbin)

splom(as.data.frame(aranjuez),
           panel=panel.hexbinplot, xlab='',
           colramp=BTC,##function(n)BTC(n, beg=250, end=5),
           diag.panel = function(x, ...){
             yrng &lt;- current.panel.limits()$ylim
             d &lt;- density(x, na.rm=TRUE)
             d$y &lt;- with(d, yrng[1] + 0.95 * diff(yrng) * y / max(y))
             panel.lines(d)
             diag.panel.splom(x, ...)
           },
           lower.panel = function(x, y, ...){
             panel.hexbinplot(x, y, ...)
             panel.loess(x, y, ..., col = 'red')
           },
           pscale=0, varname.cex=0.7
           )

</pre>


<p>
<a href="aranjuez.splom.pdf">aranjuez.splom.pdf</a>
</p>
<p>
Let's add a bit of interactivity to this plot with the
identification of some points. This task is easy with
<code>panel.link.splom</code>. The points are selected via mouse clicks (and
highlighted in green). Clicks other than left-clicks terminate the
procedure. The output of this function is the set of chosen points.
</p>


<pre class="example">trellis.focus('panel', 1, 1)
idx &lt;- panel.link.splom(pch=13, cex=0.6, col='green')
aranjuez[idx,]
</pre>


<pre class="example">
           TempAvg TempMax TempMin HumidAvg HumidMax WindAvg WindMax Rain
2007-11-16    2.05   14.56  -6.879    41.84     85.6   0.693   3.881    0
2009-04-18   11.31   17.84   7.190    75.80     96.8   1.777   7.400    0
2010-09-30   17.60   28.78   7.000    49.81     80.9   0.812   4.763    0
           Radiation       ET
2007-11-16     12.18 1.090771
2009-04-18     17.39 3.062068
2010-09-30     17.48 3.024948
</pre>



</div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Reshape</h3>
<div class="outline-text-3" id="text-1-3">

<p>A drawback of the matrix of scatter plots is that each panel is drawn
independently so it is impossible to compute a common color key
for all of them. In other words, two cells with exactly the same
color in different panels encode different points densities. 
</p>
<p>
It is possible to display a reduced set of variables against
another one and generate a common color key using the <code>hexbinplot</code>
function. First, the dataset must be reshaped from the wide format
(one colum for each variable) to the long format (only one column for
the values with one row for each observation). 
</p>
<p>
The <code>reshape</code> function needs several arguments to perform the
conversion. The most important is the <code>data.frame</code> to be
transformed. Then there is the names of variables to be mapped to
a single variable in the long dataset (the three ambient
temperatures). The name of this variable can be set with
<code>v.names</code>. Finally, <code>timevar</code> is the name of the column in long format that
differentiates multiple observations from the same variable. The
values of this column are defined with the <code>times</code> argument.
</p>



<pre class="example">aranjuezRshp &lt;- reshape(as.data.frame(aranjuez), direction='long',
                        varying=list(names(aranjuez)[1:3]),
                        v.names='Temperature',
                        times=names(aranjuez)[1:3],
                        timevar='Statistic')
</pre>




<pre class="example">head(aranjuezRshp)
</pre>



<pre class="example">          HumidAvg HumidMax WindAvg WindMax Rain Radiation        ET Statistic
1.TempAvg     88.3     95.9   0.746   3.528    0     5.490 0.5352688   TempAvg
2.TempAvg     83.3     98.5   1.078   6.880    0     6.537 0.7710499   TempAvg
3.TempAvg     75.0     94.4   0.979   6.576    0     8.810 0.8361229   TempAvg
4.TempAvg     82.0     97.0   0.633   3.704    0     9.790 0.6861381   TempAvg
5.TempAvg     83.2     97.0   0.389   2.244    0    10.300 0.5152422   TempAvg
6.TempAvg     84.5     96.5   0.436   2.136    0     9.940 0.4886631   TempAvg
          Temperature id
1.TempAvg       4.044  1
2.TempAvg       5.777  2
3.TempAvg       5.850  3
4.TempAvg       4.408  4
5.TempAvg       3.081  5
6.TempAvg       2.304  6
</pre>


<p>
The <code>hexbinplot</code> displays this dataset with a different panel for
each type of temperature (average, maximum and minimum) but with a
common color key encoding the point density. Now, two cells with
the same color in different panels encode the same value.
</p>



<pre class="example">hexbinplot(Radiation~Temperature|Statistic, data=aranjuezRshp,
           layout=c(1, 3), colramp=BTC, 
           panel=function(x, y, xlim,...){
             panel.hexbinplot(x, y, ...)
             panel.loess(x, y, ..., col = 'red')
           }
           )
</pre>


<p>
<a href="aranjuez.hexbinplot.pdf">aranjuez.hexbinplot.pdf</a>
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn.1" href="#fnr.1">1</a></sup> The <code>solaR</code> package provides the function <code>readSIAR</code>
  which is designed around this code.
</p>




</div>
</div>
</div>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2012-06-26 00:51:02 CEST</p>
<p class="author">Author: Oscar Perpiñán Lamigueiro</p>
<p class="creator">Org version 7.8.11 with Emacs version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
