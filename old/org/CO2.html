<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>World Bank</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="World Bank"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-07-09 22:43:59 CEST"/>
<meta name="author" content="Oscar Perpiñán"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/javascript" src="http://orgmode.org/mathjax/MathJax.js">
<!--/*--><![CDATA[/*><!--*/
    MathJax.Hub.Config({
        // Only one of the two following lines, depending on user settings
        // First allows browser-native MathML display, second forces HTML/CSS
        //  config: ["MMLorHTML.js"], jax: ["input/TeX"],
            jax: ["input/TeX", "output/HTML-CSS"],
        extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                     "TeX/noUndefined.js"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"], ["\\begin{displaymath}","\\end{displaymath}"] ],
            skipTags: ["script","noscript","style","textarea","pre","code"],
            ignoreClass: "tex2jax_ignore",
            processEscapes: false,
            processEnvironments: true,
            preview: "TeX"
        },
        showProcessingMessages: true,
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": {
             scale: 100,
             availableFonts: ["STIX","TeX"],
             preferredFont: "TeX",
             webFont: "TeX",
             imageFont: "TeX",
             showMathMenu: true,
        },
        MMLorHTML: {
             prefer: {
                 MSIE:    "MML",
                 Firefox: "MML",
                 Opera:   "HTML",
                 other:   "HTML"
             }
        }
    });
/*]]>*///-->
</script>
</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">World Bank</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 World Bank</a></li>
<li><a href="#sec-2">2 The Phillips curve</a></li>
<li><a href="#sec-3">3 Choosing colors</a></li>
<li><a href="#sec-4">4 Positioning labels</a></li>
<li><a href="#sec-5">5 Bubbles</a></li>
<li><a href="#sec-6">6 Animation</a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-3">
<h3 id="sec-1"><span class="section-number-3">1</span> World Bank</h3>
<div class="outline-text-3" id="text-1">



<p>
Each year of the data is stored in a column of the <code>CO2 data.frame</code>, and the country and indicator names are defined in
their respective columns. 
</p>
<p>
\index{Data!World Bank} \index{Data!CO2@$CO<sub>2</sub>$}
\index{Data!GNI}
</p>


<pre class="example">CO2 &lt;- read.csv('data/CO2_GNI_BM.csv')
head(CO2)
</pre>



<pre class="example">  Country.Name Country.Code                                Indicator.Name
1      Finland          FIN           CO2 emissions (kg per PPP $ of GDP)
2      Finland          FIN        CO2 emissions (metric tons per capita)
3      Finland          FIN            GNI, PPP (current international $)
4      Finland          FIN GNI per capita, PPP (current international $)
5       France          FRA           CO2 emissions (kg per PPP $ of GDP)
6       France          FRA        CO2 emissions (metric tons per capita)
     Indicator.Code        X2000        X2001        X2002        X2003
1 EN.ATM.CO2E.PP.GD 3.923481e-01 4.099378e-01 4.265803e-01 4.785172e-01
2    EN.ATM.CO2E.PC 1.007322e+01 1.087588e+01 1.174433e+01 1.321467e+01
3 NY.GNP.MKTP.PP.CD 1.318800e+11 1.374500e+11 1.434180e+11 1.428710e+11
4 NY.GNP.PCAP.PP.CD 2.548000e+04 2.649000e+04 2.758000e+04 2.741000e+04
5 EN.ATM.CO2E.PP.GD 2.384221e-01 2.370408e-01 2.231432e-01 2.287341e-01
6    EN.ATM.CO2E.PC 6.016236e+00 6.303892e+00 6.171683e+00 6.236447e+00
         X2004        X2005        X2006        X2007        X2008       X2009
1 4.289469e-01 3.389595e-01 3.786006e-01 3.341890e-01 2.792975e-01          NA
2 1.280953e+01 1.040875e+01 1.254696e+01 1.208669e+01 1.063578e+01          NA
3 1.573070e+11 1.618390e+11 1.761810e+11 1.913600e+11 2.033820e+11 1.93598e+11
4 3.009000e+04 3.085000e+04 3.345000e+04 3.618000e+04 3.828000e+04 3.62600e+04
5 2.212615e-01 2.105801e-01 1.918882e-01 1.770519e-01 1.720425e-01          NA
6 6.232062e+00 6.219341e+00 6.026120e+00 5.864109e+00 5.873142e+00          NA
        X2010 X2011
1          NA    NA
2          NA    NA
3 1.98866e+11    NA
4 3.70700e+04    NA
5          NA    NA
6          NA    NA
</pre>


<p>
Before using this dataset, we have to transform it in a way that
each indicator is stored in independent columns with the year and
country names in their own columns.  The first step is to reshape
it to the long format. After this, the <code>data.frame</code> shows the year
in its own column (<code>timevar = 'Year'=), but now the values of the indicators are all mixed in a unique column (=v.names</code>'Value'=).
\index{reshape@\texttt{reshape}}
</p>


<pre class="example">CO2data &lt;- reshape(CO2, varying=list(names(CO2)[5:16]),
                      timevar='Year', v.names='Value',
                      times=2000:2011,
                      direction='long')
head(CO2data)
</pre>



<pre class="example">       Country.Name Country.Code                                Indicator.Name
1.2000      Finland          FIN           CO2 emissions (kg per PPP $ of GDP)
2.2000      Finland          FIN        CO2 emissions (metric tons per capita)
3.2000      Finland          FIN            GNI, PPP (current international $)
4.2000      Finland          FIN GNI per capita, PPP (current international $)
5.2000       France          FRA           CO2 emissions (kg per PPP $ of GDP)
6.2000       France          FRA        CO2 emissions (metric tons per capita)
          Indicator.Code Year        Value id
1.2000 EN.ATM.CO2E.PP.GD 2000 3.923481e-01  1
2.2000    EN.ATM.CO2E.PC 2000 1.007322e+01  2
3.2000 NY.GNP.MKTP.PP.CD 2000 1.318800e+11  3
4.2000 NY.GNP.PCAP.PP.CD 2000 2.548000e+04  4
5.2000 EN.ATM.CO2E.PP.GD 2000 2.384221e-01  5
6.2000    EN.ATM.CO2E.PC 2000 6.016236e+00  6
</pre>


<p>
The second step is to transform the previous result to the wide
format. Now <code>reshape</code> keeps the columns of country names and years
(<code>idvar=c('Country.Name','Year')</code>), and add additional columns for
each level of the indicator vector (<code>timevar</code>'Indicator.Name'=).
</p>


<pre class="example">CO2data &lt;- CO2data[, c(1, 3, 5, 6)]
CO2data &lt;- reshape(CO2data, 
                   idvar=c('Country.Name','Year'),
                   timevar='Indicator.Name', direction='wide')

names(CO2data)[3:6] &lt;- c('CO2.PPP', 'CO2.capita', 'GNI.PPP', 'GNI.capita')

isNA &lt;- apply(is.na(CO2data), 1, any)
CO2data &lt;- CO2data[!isNA, ]

head(CO2data)
</pre>


<pre class="example">
        Country.Name Year   CO2.PPP CO2.capita     GNI.PPP GNI.capita
1.2000       Finland 2000 0.3923481  10.073216 1.31880e+11      25480
5.2000        France 2000 0.2384221   6.016236 1.55899e+12      25660
9.2000       Germany 2000 0.3929031  10.121466 2.09545e+12      25490
13.2000       Greece 2000 0.4598579   8.391709 2.00013e+11      18320
17.2000        Italy 2000 0.3041930   7.835266 1.45558e+12      25560
21.2000  Netherlands 2000 0.3530871  10.383550 4.78443e+11      30040
</pre>


</div>

</div>

<div id="outline-container-2" class="outline-3">
<h3 id="sec-2"><span class="section-number-3">2</span> The Phillips curve</h3>
<div class="outline-text-3" id="text-2">



<p>
Instead of using different panels for each country, comparisons
are easier if the collection of country curves is superposed in
one panel. Each curve will be distinguished with its color and
label.
</p>
</div>

</div>

<div id="outline-container-3" class="outline-3">
<h3 id="sec-3"><span class="section-number-3">3</span> Choosing colors</h3>
<div class="outline-text-3" id="text-3">


<p>
The <code>Country.Name</code> categorical variable will be encoded with a
qualitative palette, for example the <code>Set1</code> palette of the
<code>RColorBrewer</code>. Since this palette provides only 9 colors we have
to repeat some colors to complete the number of levels of the
variable <code>Country.Name</code>. The result is a palette with non-unique
colors, and thus some countries will share the same color. This is
not a problem since the curves will be labelled, and countries with
the same color will be displayed at enough distance.
\index{Packages!RColorBrewer@\texttt{RColorBrewer}}
\index{brewer.pal@\texttt{brewer.pal}}
</p>


<pre class="example">library(RColorBrewer)

nCountries &lt;- nlevels(CO2data$Country.Name)
pal &lt;- rep(brewer.pal(n=9, 'Set1'),
           length = nCountries)
</pre>



<p>
Adjacent colors of this palette are easily
distinguishable. Therefore, the connection between colors and
countries must be in a such a way that nearby lines are encoded
with adjacent colors of the palette. 
</p>
<p>
A simple approach is to calculate the annual average of the
variable to be represented along the x-axis (<code>CO2.capita</code>), and
extract colors from the palette according to the order of this
value.  
\index{aggregate@\texttt{aggregate}}
</p>


<pre class="example">## Rank of average values of CO2 per capita
CO2mean &lt;- aggregate(CO2.capita ~ Country.Name, data=CO2data, FUN=mean)
palOrdered &lt;- pal[rank(CO2mean$CO2.capita)]  
</pre>



<p>
A more sophisticated solution is to use the ordered results of a
hierarchical clustering of the time evolution of the \(CO_2\) per
capita values. The data is extracted from the original CO2
<code>data.frame</code>.  
\index{hclust@\texttt{hclust}}
</p>


<pre class="example">CO2capita &lt;- subset(CO2, Indicator.Code=='EN.ATM.CO2E.PC')
hCO2 &lt;- hclust(dist(CO2capita[, -c(1:4)]))
</pre>




<pre class="example">plot(hCO2, labels=CO2capita$Country.Name,
     xlab='', ylab='', sub='', main='')
</pre>


<p>
<a href="figs/hclust.pdf">figs/hclust.pdf</a>
</p>
<p>
The colors of the palette are assigned to each country with <code>match</code>,
which returns a vector of the positions of the matches of
<code>levels(CO2data$Country.Name)</code> (country names in alphabetical order)
in <code>CO2capita$Country.Name[hCO2$order]</code> (country names ordered
according to the hierarchical clustering). 
</p>


<pre class="example">idx &lt;- match(levels(CO2data$Country.Name), 
             CO2capita$Country.Name[hCO2$order])
palOrdered &lt;- pal[idx]  
</pre>



<p>
Finally, with <code>custom.theme</code>, the palette is encapsulated in a new
theme for <code>xyplot</code>. It must be highlighted that this palette links
colors with the levels of <code>Country.Name</code> (country names in
alphabetical order), which is exactly what the <code>groups</code> argument
provides.  
</p>
<p>
\index{custom.theme@\texttt{custom.theme}}
</p>


<pre class="example">myTheme &lt;- custom.theme(pch=19, cex=0.6, symbol=palOrdered)

pCO2.capita &lt;- xyplot(GNI.capita  ~ CO2.capita,
                      xlab="CO2 emissions (metric tons per capita)",
                      ylab="GNI per capita, PPP (current international $)",
                      groups=Country.Name, data=CO2data,
                      par.settings=myTheme,
                      type='b')
</pre>



<p>
This <code>trellis</code> object displays a curve for each country using
different colors to distinguish them. A first improvement is to show
the time evolution with labels displaying the years.  A panel function
with <code>panel.text</code> to print the year labels, and <code>panel.superpose</code> to
display the lines for each group will do the work. In the panel
function, <code>subscripts</code> is a vector with the integer indices
representing the rows of the <code>data.frame</code> to be displayed in the
panel.
</p>

<p>
\index{panel.text@\texttt{panel.text}}
\index{subscripts@\texttt{subscripts}} \index{Panel function}
\index{panel.superpose@\texttt{panel.superpose}}
</p>


<pre class="example">xyplot(GNI.capita  ~ CO2.capita,
       xlab="CO2 emissions (metric tons per capita)",
       ylab="GNI per capita, PPP (current international $)",
       groups=Country.Name, data=CO2data,
       par.settings=myTheme,
       type='b', 
       panel=function(x, y, ..., subscripts, groups){
         panel.text(x, y, ...,
                    labels=CO2data$Year[subscripts],
                    pos=2, cex=0.5, col='gray')
         panel.superpose(x, y, subscripts, groups,...)
       }
       )
</pre>



<p>
The same result with a possibly clearer code is obtained with the
combination of <code>+.trellis</code>, <code>glayer_</code> and <code>panel.text</code>. Using
<code>glayer_</code> instead of <code>glayer</code> we ensure that the labels are
printed below the lines.
</p>
<p>
\index{Packages!latticeExtra@\texttt{latticeExtra}}
\index{glayer@\texttt{glayer}}
\index{<del>.trellis@\texttt{</del>.trellis}}
</p>


<pre class="example">library(latticeExtra)

pCO2.capita &lt;- pCO2.capita +
    glayer_(panel.text(..., labels=CO2data$Year[subscripts],
                       pos=2, cex=0.5, col='gray'))

</pre>




</div>

</div>

<div id="outline-container-4" class="outline-3">
<h3 id="sec-4"><span class="section-number-3">4</span> Positioning labels</h3>
<div class="outline-text-3" id="text-4">


<p>
The common solution to relate each curve with the group name is to
add a legend (<code>auto.key=TRUE</code>). However, a legend can be confusing
with too many items. Besides, the reader must carry out a complex
task: choose the line, memorize its color, search for it in the
legend and read the country name.
</p>
<p>
A better approach is to label each line using nearby text and the
same color encoding. A simple method is to place the labels close
to the end of each line, once again with <code>+.trellis</code>, <code>glayer</code> and
<code>panel.text</code>. In this call, <code>group.value</code> provides the country
name and <code>group.number</code> the index of each country to choose the
color from the palette.
</p>
<p>
\index{group.value@\texttt{group.value}}
\index{group.number@\texttt{group.number}}
</p>


<pre class="example">pCO2.capita +
  glayer(panel.text(x[9], y[9],
                    labels= group.value,
                    col=palOrdered[group.number],
                    pos=4, offset=0.7, cex=0.7))
</pre>


<p>
<a href="figs/CO2_capita.pdf">figs/CO2<sub>capita</sub>.pdf</a>
</p>
<p>
This simple solution cannot solve the overlapping between labels
and lines. The package <code>directlabels</code> includes a wide repertory of
positioning methods to cope with this problem. The main function,
<code>direct.label</code>, is able to determine a suitable method for each
plot, although the user can choose a different method from the
collection or even define a custom method. For the <code>pCO2.capita</code>
object I have obtained the best results with <code>extreme.grid</code>.
</p>
<p>
\index{Packages!directlabels@\texttt{directlabels}}
\index{direct.label@\texttt{direct.label}}
</p>


<pre class="example">library(directlabels)
direct.label(pCO2.capita, method='extreme.grid')
</pre>


<p>
<a href="figs/CO2_capitaDL.pdf">figs/CO2<sub>capitaDL</sub>.pdf</a>
</p>
</div>

</div>

<div id="outline-container-5" class="outline-3">
<h3 id="sec-5"><span class="section-number-3">5</span> Bubbles</h3>
<div class="outline-text-3" id="text-5">





<pre class="example">library(classInt)
z &lt;- CO2data$CO2.PPP
intervals &lt;- classIntervals(z, n=7, style='fisher')
nInt &lt;- length(intervals$brks) - 1

idx &lt;- findCols(intervals)

op &lt;- options(digits=2)
tab &lt;- classInt:::tableClassIntervals(cols = idx, brks = intervals$brks,
                                      under = "under", over = "over", between = "-", 
                                      cutlabels = TRUE,
                                      intervalClosure = "left",
                                      dataPrecision = NULL)
options(op)

size &lt;- c(0.3, 2)
pwr.size &lt;- 1
rval &lt;- seq(1, 0, length=nInt)
cex.key &lt;- size[2] - diff(size)*rval^pwr.size 
CO2data$cexPoints &lt;- cex.key[idx]

key &lt;- list(space='right',
            title='CO2.PPP', cex.title=1,
            text=list(labels=names(tab), cex=0.85),
            points=list(col='black', pch=19, cex=cex.key, alpha=0.7))

</pre>




<pre class="example">xyplot(GNI.capita~CO2.capita|Year, data=CO2data,
       groups=Country.Name, key=key, alpha=0.7,
       strip=strip.custom(strip.levels=c(TRUE, TRUE)),
       panel=function(x, y, cex.values,..., subscripts, groups){
         panel.text(x, y, ...,
                    labels=groups[subscripts],
                    col=palOrdered[groups[subscripts]],
                    pos=3, cex=0.6)
         panel.points(x, y, col=palOrdered[groups[subscripts]],
                      cex=CO2data$cex[subscripts])
       })


</pre>


<p>
<a href="figs/CO2points.pdf">figs/CO2points.pdf</a>
</p>



<pre class="example">xyplot(GNI.capita~CO2.capita|Year, data=CO2data,
       groups=Country.Name, aspect=1,
       strip=strip.custom(strip.levels=c(TRUE, TRUE)),
       panel=function(x, y, ..., subscripts, groups) {
         color &lt;- palOrdered[groups[subscripts]]
         radius &lt;- CO2data$CO2.PPP[subscripts]
         grid.text(label=groups[subscripts],
                   unit(x, 'native'),
                   unit(y, 'native') + radius * unit(.15, 'inch'),
                   gp=gpar(col=color, cex=0.7))
         grid.circle(x, y, default.units='native',
                     r=radius * unit(.1, 'inch'),
                     gp=gpar(col=color,
                       fill=adjustcolor(color, alpha=.5),
                       lwd=1))
       })
</pre>


<p>
<a href="figs/CO2bubbles.pdf">figs/CO2bubbles.pdf</a>
</p>

</div>

</div>

<div id="outline-container-6" class="outline-3">
<h3 id="sec-6"><span class="section-number-3">6</span> Animation</h3>
<div class="outline-text-3" id="text-6">





<pre class="example">xyplot(GNI.capita ~ CO2.capita, data=CO2data,
       subset=Year==2000, groups=Country.Name,
       xlim=extendrange(CO2data$CO2.capita),
       ylim=extendrange(CO2data$GNI.capita),
       panel=function(x, y, ..., subscripts, groups) {
         color &lt;- palOrdered[groups[subscripts]]
         radius &lt;- CO2data$CO2.PPP[subscripts]
         grid.circle(x, y, default.units="native",
                     r=radius*unit(.25, "inch"),
                     name=trellis.grobname("points", type="panel"),
                     gp=gpar(col=color,
                       fill=adjustcolor(color, alpha=.5),
                       lwd=2))
         grid.text(label=groups[subscripts],
                   unit(x, 'native'),
                   unit(y, 'native') + radius*unit(.4, 'inch'),
                   name=trellis.grobname('labels', type='panel'),
                   gp=gpar(col=color, cex=0.7))
       })

nCountries &lt;- nlevels(CO2data$Country.Name)

x_points &lt;- animUnit(unit(CO2data$CO2.capita, 'native'),
                     id=rep(1:14, 9))
y_points &lt;- animUnit(unit(CO2data$GNI.capita, 'native'),
                     id=rep(1:14, 9))
y_labels &lt;- animUnit(unit(CO2data$GNI.capita, 'native') + CO2data$CO2.PPP * unit(.4, 'inch'),
                     id=rep(1:14, 9))

size &lt;- animUnit(CO2data$CO2.PPP * unit(.25, 'inch'),
                 id=rep(1:14, 9))

grid.animate(trellis.grobname("points", type="panel", row=1, col=1),
             duration=20,
             x=x_points,
             y=y_points,
             r=size,
             rep=TRUE)

grid.animate(trellis.grobname("labels", type="panel", row=1, col=1),
             duration=20,
             x=x_points,
             y=y_labels,
             rep=TRUE)

years &lt;- unique(CO2data$Year)
visibility &lt;- matrix("hidden", nrow=length(years), ncol=length(years))
diag(visibility) &lt;- "visible"
yearText &lt;- animateGrob(garnishGrob(textGrob(years, .9, .15,
                                             name="year",
                                             gp=gpar(cex=2, col="grey")),
                                    visibility="hidden"),
                        duration=20,
                        visibility=visibility,
                        rep=TRUE)
grid.draw(yearText)

gridToSVG("figs/bubbles.svg")
</pre>




<pre class="example">library(googleVis)
pgvis &lt;- gvisMotionChart(CO2data, idvar='Country.Name', timevar='Year')
</pre>







</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2012-07-09 22:43:59 CEST</p>
<p class="author">Author: Oscar Perpiñán</p>
<p class="creator">Org version 7.8.09 with Emacs version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
