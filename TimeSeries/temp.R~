xx <- unemployUSA
## autoplot no entiende as.yearmon
index(xx) <- as.Date(index(xx))
autoplot(unemployUSA[,1:6], facets=NULL) + geom_area()

dat <- stack(as.data.frame(unemployUSA))
dat$date <- index(unemployUSA)
names(dat) <- c('y', 'groups', 'x')
## dat <- data.frame(x=x, y=y, groups=groups)
nVars <- nlevels(dat$groups)
groupLevels <- levels(dat$groups)
  
## From long to wide
yWide <- unstack(dat, y~groups)
## Where are the maxima of each variable located? We will use
## them to position labels.
idxMaxes <- apply(yWide, 2, which.max)

##Origin calculated following Havre.Hetzler.ea2002
if (origin=='themeRiver') origin= -1/2*rowSums(yWide)
else origin=0 
yWide <- cbind(origin=origin, yWide)
## Cumulative sums to define the polygon
yCumSum <- t(apply(yWide, 1, cumsum))
Y <- as.data.frame(sapply(seq_len(nVars),
                              function(iCol)c(yCumSum[,iCol+1],
                                              rev(yCumSum[,iCol]))))
names(Y) <- levels(dat$groups)
## Back to long format, since xyplot works that way
y <- stack(Y)$values

## Similar but easier for x
xWide <- unstack(dat, x~groups)
x <- rep(c(xWide[,1], rev(xWide[,1])), nVars)
## Groups repeated twice (upper and lower limits of the polygon)
groups <- rep(dat$groups, each=2)


dat2 <- data.frame(x, y, groups)
ggplot() + 
    geom_area(data = dat2, aes(x=x, y=y, fill=groups))## + 
##    geom_area(data = liabilnm, aes(x=dates, y=value, fill=variable))

idxMaxes <- apply(unemployUSA, 2, which.max)
origin= -1/2*rowSums(unemployUSA)

xOrigin <- unemployUSA + origin

xOrigin <- stack(as.data.frame(xOrigin))
xOrigin$date <- index(unemployUSA)

x <- stack(as.data.frame(unemployUSA))
x$date <- index(unemployUSA)

ggplot() +
  geom_area(data=xOrigin, aes(x=date, y=values, fill=ind))
